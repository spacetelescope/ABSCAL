pro ttcorr,hd,wav,flux,notime=notime,version=version,tcorr=tcorr,silent=silent,$
	wcorr=wcorr,time=time,notemp=notemp
;+
;
; 98jul17 - time and temperature correction for STIS low dispersion
; INPUT:
;	hd - stis header
;	wav - Instrumental. obs wavelength vector w/ heliocentric vel removed.
;	flux - vector to correct, eg NET or FLUX
;	notime - keyword: do not make time corr. (just temp corr)
;	notemp - do not make temp correction for tcorrel.pro
; OUTPUT:
;	flux - as corrected for time and/or temp changes
;	tcorr - keyword w/ value of temp correction
;	wcorr - the time correction, added by DJL
;	time - keyword: for time of obs.
; REFERENCE - Bohlin, R. 1999,Instrument Science Report, STIS 99-07.
; HISTORY
;	99dec7 - DJL, added version, corrections, time, and silent keyword
;		parameters, modified to work for Medium and Echelle
;	Jan 21, 2000 - DJL, modfied to use EXPSTART keyword when PSTRTIME is
;		missing
;	02jul23 - L-flat for G140L & 0.36 PX WL fix for G230L
;	06apr13 - install G430L and G750L L-flats (~negligible diffs)
;	14sep18 - add gwidth=11 time corrections for G750L.
;	14sep22 - add gwidth=11 temperture corrections for G750L.
;	2017jan27 - fix ttcorr for g750L tchange for ht=7 HZ43. Vega?
; 2019mar20 - add gwidth=11 corr for g230lb and g430L & use for all gwid>=11
; 	2019may9 - Switch to spline node fits to time change. Hgt=7 Not done, so
;		use hgt 11 results for odd hgt=7 processing, eg HZ43.
;-
	VERSION = 'Bohlin/May, 2019 ttcorr '

;G140L time change array
; 1175. 1225. 1275. 1325. 1375. 1425. 1475. 1525. 1575. 1625. 1675.
; Nodes: 1997.38   1999.20   2001.80   2004.00   2004.50   2009.50   2013.00
; 2016.00   2019.10
tc140l=[								$
  1.114143,  1.074316,  1.004755,  0.965878,  0.959160,  0.940097,  0.921153, $
  0.892941,  0.865632,  1.044697,  1.021319,  0.997855,  0.987456,  0.977098, $
  0.988434,  0.971455,  0.973130,  0.957524,  1.038942,  1.022597,  0.994332, $
  0.985452,  0.981506,  0.990289,  0.975015,  0.975650,  0.965846,  1.043744, $
  1.028826,  0.992086,  0.980767,  0.977093,  0.983828,  0.971649,  0.969740, $
  0.964516,  1.051049,  1.034946,  0.994503,  0.977083,  0.972228,  0.973901, $
  0.965786,  0.960335,  0.953314,  1.074285,  1.047467,  0.992637,  0.971480, $
  0.963754,  0.963764,  0.951455,  0.945762,  0.931733,  1.095026,  1.054927, $
  0.992947,  0.965647,  0.958623,  0.949697,  0.942449,  0.935825,  0.918560, $
  1.116278,  1.062346,  0.992879,  0.955813,  0.948763,  0.940857,  0.932057, $
  0.928830,  0.902482,  1.121695,  1.065225,  0.987205,  0.951617,  0.946900, $
  0.930379,  0.935318,  0.934035,  0.906248,  1.128722,  1.071873,  0.981400, $
  0.949671,  0.942545,  0.928566,  0.931515,  0.933495,  0.898275,  1.099208, $
  1.075878,  0.984139,  0.953878,  0.950204,  0.934493,  0.932993,  0.932016, $
  0.896904]	; 2019aug
; G230L time change array 
; 1650. 1750. 1850. 1950. 2050. 2150. 2250. 2350. 2450. 2550. 2650. 2750. 2850.
; 2950. 3050.
; nodes: 1997.38   1998.60   1999.00   1999.20   1999.40   2002.60   2004.00
; 2004.50   2009.50   2011.20   2013.30   2015.60   2019.10
tc230l=[								$
  1.020851,  1.034719,  1.038296,  1.042045,  1.040679,  0.985475,  0.981136, $
  0.985408,  0.950172,  0.960551,  0.965229,  0.974747,  0.963735,  1.031009, $
  1.045303,  1.047623,  1.048973,  1.047867,  0.978653,  0.968136,  0.966022, $
  0.948526,  0.960265,  0.963181,  0.959464,  0.955430,  1.028801,  1.047093, $
  1.054037,  1.055907,  1.054923,  0.978797,  0.969191,  0.969231,  0.950261, $
  0.969031,  0.957182,  0.944206,  0.947561,  1.036015,  1.055118,  1.063424, $
  1.066184,  1.064196,  0.977975,  0.969219,  0.971592,  0.953218,  0.968829, $
  0.948411,  0.928378,  0.935520,  1.040794,  1.062478,  1.067026,  1.067163, $
  1.065362,  0.977409,  0.971571,  0.973656,  0.952948,  0.963535,  0.943762, $
  0.922956,  0.924833,  1.036760,  1.060951,  1.062391,  1.060401,  1.057723, $
  0.983542,  0.975852,  0.975382,  0.956801,  0.961010,  0.948808,  0.931901, $
  0.923921,  1.029369,  1.060922,  1.053987,  1.051864,  1.049911,  0.987375, $
  0.979816,  0.977103,  0.958887,  0.957751,  0.954009,  0.936970,  0.929891, $
  1.033447,  1.057052,  1.050856,  1.049736,  1.046588,  0.992807,  0.981600, $
  0.980039,  0.958830,  0.959570,  0.952852,  0.938503,  0.932788,  1.038023, $
  1.048840,  1.050122,  1.045281,  1.041804,  0.997610,  0.984053,  0.983903, $
  0.957066,  0.961770,  0.952189,  0.942505,  0.929369,  1.035493,  1.042359, $
  1.043463,  1.042379,  1.039002,  1.000605,  0.986370,  0.987685,  0.962585, $
  0.966030,  0.954977,  0.947242,  0.933023,  1.026924,  1.040574,  1.038949, $
  1.036341,  1.034035,  0.998648,  0.989144,  0.992673,  0.964733,  0.968877, $
  0.960405,  0.953219,  0.939120,  1.023200,  1.036417,  1.037011,  1.034823, $
  1.032492,  0.999972,  0.990651,  0.994783,  0.969713,  0.971174,  0.963078, $
  0.955999,  0.942012,  1.020881,  1.034498,  1.032504,  1.029363,  1.027855, $
  0.998055,  0.992462,  0.993997,  0.974500,  0.971651,  0.971031,  0.961172, $
  0.947498,  1.017411,  1.034337,  1.029344,  1.030731,  1.028633,  1.001036, $
  0.990274,  0.992261,  0.975897,  0.975035,  0.969143,  0.959937,  0.951138, $
  1.014778,  1.032565,  1.029456,  1.028705,  1.026888,  0.999659,  0.992838, $
  0.992158,  0.975756,  0.976746,  0.973830,  0.962679,  0.954328]  ;2019aug

; G230LB time change array
; 1750. 1850. 1950. 2050. 2150. 2250. 2350. 2450. 2550. 2650. 2750. 2850. 2950.
; nodes: 1997.38   1998.60   1999.00   1999.20   1999.40   2002.60   2004.00
; 2004.50   2009.50   2011.20   2013.30   2015.60   2019.10
tc230lb=[								$
  1.089602,  1.091699,  1.095906,  1.094072,  1.091832,  1.010972,  1.000031, $
  0.995348,  0.969595,  0.975684,  0.974407,  0.969818,  0.956441,  1.084264, $
  1.096710,  1.106347,  1.105546,  1.103758,  1.013355,  1.003047,  1.000153, $
  0.974838,  0.984219,  0.969274,  0.953445,  0.951786,  1.090140,  1.107491, $
  1.114205,  1.113531,  1.111357,  1.015762,  1.006330,  1.003226,  0.981692, $
  0.989470,  0.964570,  0.940689,  0.944617,  1.103275,  1.115628,  1.120189, $
  1.117242,  1.113700,  1.017939,  1.008096,  1.005829,  0.984739,  0.985330, $
  0.963296,  0.940055,  0.936291,  1.091812,  1.104144,  1.106518,  1.103602, $
  1.100613,  1.020456,  1.011249,  1.008353,  0.981134,  0.982789,  0.966846, $
  0.948121,  0.937868,  1.079428,  1.094948,  1.095119,  1.092080,  1.089420, $
  1.022617,  1.013253,  1.010215,  0.979617,  0.979948,  0.968842,  0.955836, $
  0.939229,  1.071330,  1.087065,  1.085043,  1.083058,  1.081045,  1.024448, $
  1.014416,  1.011040,  0.979665,  0.980313,  0.970660,  0.958454,  0.941553, $
  1.066578,  1.081329,  1.078888,  1.076970,  1.074838,  1.023759,  1.013549, $
  1.011350,  0.982801,  0.981098,  0.971434,  0.961402,  0.944532,  1.059138, $
  1.070244,  1.069484,  1.066747,  1.065020,  1.022377,  1.014502,  1.012032, $
  0.985465,  0.982520,  0.974195,  0.964819,  0.949683,  1.051489,  1.061966, $
  1.060187,  1.059435,  1.057930,  1.022084,  1.014477,  1.012272,  0.987216, $
  0.984800,  0.975722,  0.967689,  0.953407,  1.048486,  1.057513,  1.056072, $
  1.055363,  1.053966,  1.021863,  1.014287,  1.013156,  0.987644,  0.984462, $
  0.977282,  0.969829,  0.955173,  1.050417,  1.055962,  1.054108,  1.052379, $
  1.050887,  1.021587,  1.013878,  1.011918,  0.988595,  0.985138,  0.977521, $
  0.970908,  0.956239,  1.050914,  1.052768,  1.050662,  1.049122,  1.048023, $
  1.020113,  1.013487,  1.011539,  0.989027,  0.985307,  0.978567,  0.972600, $
  0.958384]					; 2019 aug

; G430L time change array:
; 3000. 3200. 3400. 3600. 3800. 4000. 4200. 4400. 4600. 4800. 5000. 5200. 5400.
; 5600.
; nodes: 1997.38   1999.00   2004.00   2004.50   2009.50   2012.00   2014.50
; 2015.50   2018.00   2019.10
tc430l=[								$ 
  1.025021,  1.026869,  1.006280,  1.007278,  0.995830,  0.991780,  0.987736, $
  0.986489,  0.976331,  0.975020,  1.030890,  1.031205,  1.007505,  1.007365, $
  0.995672,  0.989319,  0.984770,  0.981912,  0.972950,  0.971054,  1.030984, $
  1.029072,  1.008249,  1.008021,  0.996157,  0.989123,  0.984983,  0.982860, $
  0.974006,  0.972359,  1.032173,  1.026936,  1.008131,  1.007640,  0.996779, $
  0.989758,  0.985788,  0.984342,  0.975343,  0.973184,  1.031319,  1.027638, $
  1.008224,  1.007702,  0.995065,  0.989146,  0.985555,  0.983955,  0.975792, $
  0.974179,  1.029767,  1.025779,  1.008600,  1.007947,  0.995330,  0.989705, $
  0.986110,  0.984398,  0.976691,  0.973961,  1.030866,  1.026309,  1.008614, $
  1.008077,  0.995203,  0.989303,  0.985766,  0.983855,  0.976916,  0.975075, $
  1.031523,  1.024710,  1.008420,  1.007585,  0.995702,  0.990397,  0.985887, $
  0.984798,  0.977617,  0.975278,  1.031284,  1.025645,  1.008684,  1.008157, $
  0.995230,  0.990043,  0.985331,  0.984529,  0.977235,  0.974796,  1.031825, $
  1.025028,  1.008886,  1.008174,  0.996046,  0.989953,  0.985310,  0.984287, $
  0.977241,  0.974989,  1.031922,  1.023965,  1.008824,  1.007857,  0.995750, $
  0.990326,  0.986019,  0.984715,  0.977701,  0.976127,  1.031896,  1.024317, $
  1.008429,  1.007549,  0.996036,  0.989332,  0.986255,  0.984930,  0.978954, $
  0.976149,  1.032539,  1.023895,  1.008683,  1.007836,  0.995354,  0.990045, $
  0.986367,  0.984924,  0.979033,  0.976484,  1.030269,  1.023041,  1.008234, $
  1.007519,  0.995641,  0.989721,  0.986877,  0.985786,  0.979976,  0.978690]
; 19aug

; G750L time change array:
; 5700. 6100. 6500. 6900. 7300. 7700. 8100. 8500. 8900. 9300. 9700.
; nodes: 1997.38   1999.30   2004.00   2004.50   2009.50   2012.00   2014.50
; 2015.50   2018.00   2019.10
tc750l=[								$ 
  1.011815,  1.009419,  1.002286,  1.001687,  0.996942,  0.991717,  0.992625, $
  0.991747,  0.988054,  0.986493,  1.013802,  1.011163,  1.003082,  1.002116, $
  0.996668,  0.990430,  0.989952,  0.988580,  0.985944,  0.983463,  1.015058, $
  1.011122,  1.002604,  1.001711,  0.996435,  0.991302,  0.989871,  0.989742, $
  0.985782,  0.983181,  1.016390,  1.012044,  1.003330,  1.002281,  0.995526, $
  0.989234,  0.989523,  0.988585,  0.985122,  0.982311,  1.019292,  1.012573, $
  1.004001,  1.002828,  0.996446,  0.989387,  0.987878,  0.986833,  0.982818, $
  0.980456,  1.018654,  1.012944,  1.005409,  1.004191,  0.995906,  0.988598, $
  0.986906,  0.986028,  0.981137,  0.978516,  1.019744,  1.012140,  1.006782, $
  1.005784,  0.995024,  0.990912,  0.986804,  0.985688,  0.979546,  0.976799, $
  1.028863,  1.018606,  1.005802,  1.005070,  0.994053,  0.985849,  0.982760, $
  0.981270,  0.974775,  0.972224,  1.025127,  1.016779,  1.005917,  1.005014, $
  0.994918,  0.987688,  0.983271,  0.983147,  0.975145,  0.973271,  1.030712, $
  1.018928,  1.006926,  1.006310,  0.993939,  0.985608,  0.982743,  0.980742, $
  0.973218,  0.968319,  1.042462,  1.027746,  1.003359,  1.003747,  0.992363, $
  0.982097,  0.978654,  0.976231,  0.967392,  0.964146]		; 2019aug
  
opt_elem=strtrim(sxpar(hd,'opt_elem'),2)
case opt_elem of	
  'G140L' : mode = 'G140L'
  'G140M' : mode = 'G140L'
  'E140M' : mode = 'G140L'
  'E140H' : mode = 'G140L'
  'G230L' : mode = 'G230L'
  'G230M' : mode = 'G230L'
  'E230M' : mode = 'G230L'
  'E230H' : mode = 'G230L'
  'PRISM' : mode = 'G230L'
  'G230LB': Mode = 'G230LB'
  'G230MB': Mode = 'G230LB'
  'G430L' : Mode = 'G430L'
  'G430M' : Mode = 'G430L'
  'G750L' : Mode = 'G750L'
  'G750M' : Mode = 'G750L'
  else: return
  endcase

; !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!1
;###change (BUT not before getting the new nodes from make-tchang)
; !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!1

if mode eq 'G140L' then nodtim=[1997.38,1999.20,2001.80,2004.00,2004.50,$
	2009.50,2013.00,2016.00,2019.10]
if mode eq 'G230L' then nodtim=[1997.38,1998.60,1999.00,1999.20,	$
	1999.40,2002.60,2004.00,2004.50,2009.50,2011.20,		$
	2013.30,2015.60,2019.10]
if mode eq 'G230LB' then nodtim=[1997.38,1998.60,1999.00,1999.20,	$
	1999.40,2002.60,2004.00,2004.50,2009.50,2011.20,		$
	2013.30,2015.60,2019.10]
if mode eq 'G430L' then nodtim=[1997.38,1999.00,2004.00,2004.50,	$
	2009.50,2012.00,2014.50,2015.50,2018.00,2019.10]
if mode eq 'G750L' then nodtim=[1997.38,1999.30,2004.00,2004.50,	$
	2009.50,2012.00,2014.50,2015.50,2018.00,2019.10]

; ******** END SECTION FOR UPDATES (except temp coeff below) ***************

time=absdate(sxpar(hd,'pstrtime'))  &  time=time(0)	; change yyddd to yr.xxx
if time eq 0 then begin					;use MJD from EXPSTART
        mjd = sxpar(hd,'texpstrt')			; 02sep23
 	caldat,mjd+2400000.5d0,month,day,year,hour	; Julian to calendar
	time = year + (ymd2dn(year,month,day)+hour/24.0)/365.25d0
	endif
tcorr = 1.0				; default, applies to G230L
wcorr = 1.0

case mode of
; TEMPERATURE corrections from temp only fits. Time changes SHOULD be removed!
  'G140L' : begin
 	temp=sxpar(hd,'om1cat')
	if temp le 20 or temp ge 50 then begin			; idiot check
		print,'WARNING: NO om1cat for temp corr in TTCOR',	$
				format='(///8x,a///)'
	    end else begin
		tcorr=1-(temp-36)*.0036		; 19jul  +-.00036 w/ spline fits

		if n_elements(flux) gt 1 and not keyword_set(notemp) then $
			flux=flux/tcorr
		endelse
	endcase
  'G230LB': begin 
 	temp=sxpar(hd,'OCCDHTAV')
 	if temp gt 0 and time gt 2001.5 then begin
		tcorr=1+(temp-19)*.0034 	;19may+/-.00014 for gwidth=11
		if n_elements(flux) gt 1 and not keyword_set(notemp) then $
			flux=flux/tcorr
		endif
	endcase
  'G430L' : begin 
 	temp=sxpar(hd,'OCCDHTAV')
 	if temp gt 0 and time gt 2001.5 then begin
		tcorr=1+(temp-19)*.0021 	;19may+/-.00011 for gwidth=11
		if n_elements(flux) gt 1 and not keyword_set(notemp) then $
			flux=flux/tcorr
		endif
	endcase
  'G750L' : begin 
 	temp=sxpar(hd,'OCCDHTAV')
 	if temp gt 0 and time gt 2001.5 then begin
		tcorr=1+(temp-19)*.0012 	;19jul+/-.00014
		if n_elements(flux) gt 1 and not keyword_set(notemp) then $
			flux=flux/tcorr
		endif
	endcase
  else:
  endcase
			if not keyword_set(silent) then print,mode,	$
				' temp. corr(flux devisor)=',tcorr
if keyword_set(notime) then return

; TIME correction
;###change for new nodes
case mode of	; reform: eg reformat 10 nodes x 11wl-bins to 10x11 array
  'G140L' : begin & timcor=reform(tc140l,9,11) & wch=indgen(11)*50.+1175 & end
  'G230L' : begin & timcor=reform(tc230l,13,15) & wch=indgen(15)*100.+1650 & end
  'G230LB': begin & timcor=reform(tc230lb,13,13) & wch=indgen(13)*100.+1750 &end
  'G430L' : begin & timcor=reform(tc430l,10,14) & wch=indgen(14)*200.+3000 & end
  'G750L' : begin & timcor=reform(tc750l,10,11) & wch=indgen(11)*400.+5700 & end
  endcase


; ******** END SECTION FOR UPDATES  ***************

if time le 1997 or time ge max(nodtim)+1 then begin	; idiot check
	print,'ttcorr: Invalid Observation Date in Header = ',time
	stop
	endif
corr=timefit(nodtim,timcor,time)	; get corr in ea WL bin @ t=time
; 2019aug28 - renorm to make old gwidth=7 sensitities work:
gwid=long(sxpar(hd,'gwidth'))
if gwid eq 7 then corr=corr/timcor(0,*)	;renorm to 1 at 1997.38
wcorr=interpol(corr,wch,wav)		; 14Jul24 - extrap beyond wch ends

del=wch(1)-wch(0)
bad=where(wav lt wch(0)-del/2)  &  wcorr(bad)=wcorr(bad(-1))
bad=where(wav gt wch(-1)+del/2)  &  wcorr(bad)=wcorr(bad(0))
if n_elements(flux) gt 1 then flux=flux/wcorr
if not keyword_set(silent) then $
    if min(wcorr) lt 1 or max(wcorr) gt 1 then 				$
		print,version,mode,' Time corr. made to NET or FLUX @ ',time
return
END
